<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="description" content="Flip Phone Racer - A retro-inspired endless car racing game">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Flip Phone Racer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="loading">Loading...</div>
    
    <div id="gameContainer">
        <div id="canvasWrapper">
            <canvas id="gameCanvas"></canvas>
        </div>
    </div>
    
    <!-- Touch controls (hidden on desktop) -->
    <div id="touchControls">
        <button id="touchLeft" class="touch-button" aria-label="Move Left">◀</button>
        <button id="touchBrake" class="touch-button" aria-label="Brake">⬇</button>
        <button id="touchRight" class="touch-button" aria-label="Move Right">▶</button>
    </div>
    
    <!-- Scripts (order matters) -->
    <script src="utils.js"></script>
    <script src="storage.js"></script>
    <script src="audio.js"></script>
    <script src="game.js"></script>
    
    <script>
        // Hide loading screen when game initializes
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                const loading = document.getElementById('loading');
                if (loading) {
                    loading.classList.add('hidden');
                }
            }, 100);
        });
        
        // Prevent context menu on long press (mobile)
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        
        
        // Prevent default touch behaviors that might interfere (but not on buttons or canvas)
        document.addEventListener('touchmove', (e) => {
            // Allow touch move on interactive elements
            if (e.target.closest('#touchControls') || 
                e.target.closest('button') ||
                e.target.closest('canvas') ||
                e.target.closest('a') ||
                e.target.closest('input')) {
                return;
            }
            e.preventDefault();
        }, { passive: false });
        
        // Handle orientation change and window resize
        let resizeTimeout;
        const handleResize = () => {
            clearTimeout(resizeTimeout);
            resizeTimeout = setTimeout(() => {
                if (game && game.resizeCanvas) {
                    game.resizeCanvas();
                }
            }, 150);
        };
        
        window.addEventListener('orientationchange', handleResize);
        window.addEventListener('resize', handleResize);
        
        // Handle visual viewport changes (mobile keyboard, etc.)
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', handleResize);
        }
        
        // Set up canvas click and touch handlers (iOS needs direct canvas handlers)
        setTimeout(() => {
            const canvas = document.getElementById('gameCanvas');
            if (canvas && game) {
                // Handle canvas clicks for menu navigation (desktop)
                canvas.addEventListener('click', (e) => {
                    if (!game || !game.input) return;
                    
                    // Only handle in menu states (not during gameplay)
                    const menuStates = ['BOOT', 'TITLE', 'HOWTO', 'SETTINGS', 'PAUSED', 'GAMEOVER'];
                    if (!menuStates.includes(game.state)) return;
                    
                    // Trigger confirm action via pendingCanvasTap (same mechanism as touch)
                    game.input.pendingCanvasTap = true;
                });
                
                // Direct canvas touch handlers for iOS compatibility
                let canvasTouchStart = null;
                canvas.addEventListener('touchstart', (e) => {
                    if (!game || !game.input) return;
                    
                    // Only handle in menu states (not during gameplay)
                    const menuStates = ['BOOT', 'TITLE', 'HOWTO', 'SETTINGS', 'PAUSED', 'GAMEOVER'];
                    if (!menuStates.includes(game.state)) return;
                    
                    // Prevent default to ensure touchend fires on iOS
                    e.preventDefault();
                    
                    const touch = e.touches[0] || e.changedTouches[0];
                    if (touch) {
                        canvasTouchStart = {
                            x: touch.clientX,
                            y: touch.clientY,
                            time: Date.now()
                        };
                    }
                }, { passive: false });
                
                canvas.addEventListener('touchend', (e) => {
                    if (!game || !game.input || !canvasTouchStart) return;
                    
                    // Only handle in menu states (not during gameplay)
                    const menuStates = ['BOOT', 'TITLE', 'HOWTO', 'SETTINGS', 'PAUSED', 'GAMEOVER'];
                    if (!menuStates.includes(game.state)) return;
                    
                    e.preventDefault();
                    e.stopPropagation();
                    
                    const touch = e.changedTouches[0];
                    if (touch && canvasTouchStart) {
                        // Check if this was a tap (not a swipe)
                        const dx = touch.clientX - canvasTouchStart.x;
                        const dy = touch.clientY - canvasTouchStart.y;
                        const dt = Date.now() - canvasTouchStart.time;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        // If it's a short tap (within 50px and 300ms), mark for confirm
                        if (distance < 50 && dt < 300) {
                            game.input.pendingCanvasTap = true;
                        }
                        
                        canvasTouchStart = null;
                    }
                }, { passive: false });
                
                canvas.addEventListener('touchcancel', (e) => {
                    canvasTouchStart = null;
                }, { passive: true });
            }
        }, 200);
    </script>
</body>
</html>

